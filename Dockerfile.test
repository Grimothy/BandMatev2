# Dockerfile for testing - includes dev dependencies
FROM node:20-slim AS test

# Install system dependencies for Prisma and testing
RUN apt-get update && apt-get install -y \
    openssl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy package files
COPY backend/package*.json ./

# Install ALL dependencies (including dev dependencies for testing)
RUN npm ci

# Copy Prisma schema and generate client
COPY backend/prisma ./prisma
RUN npx prisma generate

# Copy source code
COPY backend/ ./

# Remove .env file to prevent conflicts with test environment variables
RUN rm -f .env

# Create directories for data and uploads
RUN mkdir -p /app/data /app/uploads/images /app/uploads/audio /app/uploads/stems

# Set environment variables for testing
ENV NODE_ENV=test
ENV DATABASE_URL="file:/app/data/test.db"
ENV JWT_SECRET="test-jwt-secret-for-docker"
ENV PORT=3000

# Reset database for clean test environment
RUN rm -f /app/data/test.db && npx prisma db push --force-reset

# Expose port
EXPOSE 3000

# Default command - run tests
CMD ["npm", "run", "test"]